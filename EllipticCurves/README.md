# Лабораторная работа 6: Изучение свойств группы эллиптической кривой

## Постановка задачи

Напишите программу, генерирующую и визуализирующую все решения уравнения вида `y^2 ≡ x^3 + ax + b (mod p)`, где `a, b ∈ Zp`, где `p` – простое число (т.е. точки произвольной эллиптической кривой над конечным полем). Реализуйте операции (с наглядным представлением результата):

1. Сложения двух точек кривой;
2. Удвоения точки кривой.

## Описание решения

### Точка эллиптической кривой (ECPoint)

Рассмотрим класс `ECPoint`, отвечающий за точку эллиптической кривой. Класс содержит поля `x` и `y` (координаты точки), boolean-значение `pointOfInfinity` (определяет, лежит ли точка в бесконечности), а также поле, содержащее в качестве константы такую точку. Представлено три варианта конструктора для различных входных данных (координаты в `int`, `BigInteger`, либо на основе существующей точки), методы для определения и назначения поля `pointOfInfinity`, а также метод `toString`.

### Логика эллиптических кривых (EllipticCurve)

За логику эллиптических кривых будет отвечать класс `EllipticCurve`. Он содержит 4 поля: коэффициенты `a` и `b`, модуль `p` (т.к. кривая определяется над конечным полем), генерирующая точка `g`. Представлено два варианта конструктора: значения в `int` или `BigInteger`.

Генерирующая точка `G` может породить любую другую точку в своей подгруппе над эллиптической кривой путем умножения `G` на некоторое целое число в диапазоне `[0...r]`. Число `r` называется порядком циклической подгруппы (общее число всех точек в подгруппе).

#### Поиск решений

Метод `solve` отвечает за поиск всех решений уравнения вида `y^2 ≡ x^3 + ax + b (mod p)`. В цикле перебираются все комбинации целых значений координат x и y до ограничивающего значения (модуля кривой). Чтобы вычислить, принадлежит ли определенная точка определенной эллиптической кривой над конечным полем, необходимо проверить следующее условие:

`x^3 + ax + b - y^2 ≡ 0 (mod p)`

Если условие истинно, то данная точка добавляется в массив решений, возвращаемый методом.

#### Сложение точек

Рассмотрим метод `add`, выполняющий сложение двух точек. Исходя из теории, результатом сложения точек `P` и `Q` эллиптической кривой является точка `–R`, которая в свою очередь является точкой, симметричной относительно оси ординат точке пересечения `R` эллиптической кривой и прямой, проведенной между точками
`P` и `Q`. Данное утверждение исходит из свойств абелевой группы:
`P + Q + R = 0 => P + Q = -R`. Также следует учесть следующие особенности:

1. Если `P = O` или `Q = O` (т.е. одна из точек является точкой в бесконечности), то `P + O = P и Q + O = Q` (т.к. точка в бесконечности является единичным элементом);
2. Если `P = -Q` (т.е. координаты `x` точек равны, а координата `y` точки `P` равна координате `-y` точки `Q`), то прямая, проходящая через точки, лежит вертикально и пересекает точку `О` в бесконечности. В таком случае отражением точки `O` является та же точка `O` и получается, что `P + Q = O`;
3. <span id="feature3">Если `P = Q` (или третьей точки пересечения не существует), то к точке `P` (`Q`) проводится касательная. Отражение точки пересечения касательной к эллиптической кривой является результатом сложения.</span>

Обработав исключения происходит алгебраическое сложение. Проходящая через точки `P` и `Q` прямая имеет наклон:

`m = (Yp - Yq) / (Xp - Xq)`

Пересечение этой прямой с эллиптической кривой – третья точка
`R = (Xr,Yr)`:

`Xr = m^2 - Xp - Xq`
`Yr = m(Xp - Xr) - Yp`

Сперва рассматривается <a href="#feature3">третья особенность сложения точек</a>. В таком случае для наклона используется другое уравнение:

`m = (3Xp^2 + a) / 2Yp`

Таким образом, вычисленные координаты точки, которая является результатом сложения, возвращаются методом в виде экземпляра `ECPoint`.

#### Скалярное умножение

Кроме операции сложения определим операцию скалярного умножения в методе `multiply`, которую также можно использовать и для удвоения точки кривой. Вычисление `nP` требует `n` сложений точки `P`, что имеет алгоритмическую сложность `O(2^k)`. Для реализации метода лучше использовать алгоритм удвоения-сложения, который требует только `O(log n)` точечных операций для скаляра из `n` бит. Алгоритм работает следующим образом:

1. Скаляр преобразуется в двоичную форму.
2. Переменная `result` инициализируется точкой в бесконечности эллиптической кривой.
3. Для каждого бита (начиная с младшего) двоичного скаляра выполняются следующие действия:
   - Удвоение точки `result` (т.е. в сложение точки с этой же точкой: `result = result + result`);
   - Если текущий бит равен 1, исходная точка добавляется к `result` (т.е. вычисляется сложение точек `result = result + P`).

### Представление результатов (Grid)

Для наглядного отображения точек эллиптической кривой и результата выполнения операций над ними используется класс `Grid`. Конструктор класса принимает значения `size` (размерность сетки) и `solutions` (массив точек эллиптической кривой), а также создает окно `JFrame`, в котором на пользовательском `JPanel` будут отрисовываться точки.

Кроме того, в классе присутствуют методы `setPostOpPoint` и `clearPostOpPoints`. Первый метод передает в `JPanel` точку, получившуюся в результате совершения операции, для ее явного выделения от остальных точек кривой. Второй метод очищает перечень таких точек.

Внутри класса `Grid` имеется класс `GridPanel`, выведенный из класса `JPanel`. В нем в массиве будут храниться исходные точки кривой, а также в виде хеш-таблицы точки, полученные в результате выполнения операций, и подписи к ним. В методе `paintComponent` происходит отрисовка сетки, подписей к координатным осям, а также самих точек при помощи методов.

### Точка входа

Точка входа в программу – метод `main` класса `EllipticCurve`. Здесь первым делом создается эллиптическая кривая, уравнение которой в приведенном ниже примере имеет вид `y^2 ≡ x^3 + 7 (mod 17)`. Координаты генерирующей точки: (15, 13).

Следующим шагом вызывается метод `solve`, который вернет точки кривой, передаваемые в экземпляр класса `Grid` для отрисовки. Далее демонстрируется пример удвоения точки (в данном примере – генерирующей точки). Результат операций (точки `2G` и `4G`), а также исходная точка `G` будут отображены в графическом пользовательском интерфейсе программы. Спустя 10 секунд будет произведено сложение двух точек (2, 10) и (8, 14). Результат сложения (точка `R`), а также исходные точки `P` и `Q` будут отображены в GUI программы.

---

Стоить отметить, что Светлин Наков в своей книге «Practical Cryptography for Developers» приводит используемую в программе кривую в качестве примера (Глава 6b. Assymetric Key Ciphers: Elliptic Curve Cryptography (ECC)). Полученные в результате выполнения программы точки кривой совпадают с представленными в книге точками эллиптической кривой, полученными умножением генерирующей точки на 2, 3, 4, …, 17.
